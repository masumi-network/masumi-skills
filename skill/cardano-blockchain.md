# Cardano Blockchain Fundamentals for Masumi

Deep dive into Cardano blockchain concepts essential for Masumi development.

## Why Cardano for AI Agents?

Masumi chose Cardano for three critical reasons aligned with AI agent scalability:

### 1. **Extended UTXO (eUTXO) Model**
Unlike account-based blockchains (Ethereum), Cardano uses UTXOs which enable:
- **Massive Parallelization**: Agents can transact simultaneously without global state bottlenecks
- **Predictable Fees**: Know transaction costs before execution (no failed transactions wasting fees)
- **Deterministic Execution**: Smart contracts validated before submission

### 2. **Proof-of-Stake Consensus**
- Energy efficient (critical for billions of AI agent transactions)
- Fast finality
- Decentralized stake pool operation

### 3. **Future-Proof Architecture**
- Native multi-asset support (no smart contracts needed for tokens)
- Upcoming Leios protocol for enhanced throughput
- Formal verification for smart contract security

## UTXO Model Explained

### What is a UTXO?
**U**nspent **T**ransaction **O**utput - think of it as a sealed envelope with money inside.

#### Key Properties:
- **Indivisible**: Must spend entire UTXO, receive "change" as new UTXO
- **One-time use**: Each UTXO can only be spent once
- **No global state**: Unlike accounts, UTXOs are independent
- **Multi-asset**: Can contain ADA + native tokens + NFTs simultaneously

### Real Example: Masumi Payment Flow

```
Initial State:
├─ Your Purchasing Wallet
│  └─ UTXO #1: 100 ADA + 500 USDM

Transaction: Pay 50 USDM for agent service
├─ Inputs:
│  └─ UTXO #1 (consumed entirely)
│
├─ Outputs:
│  ├─ Smart Contract UTXO: 50 USDM (locked for seller)
│  ├─ Your Change UTXO: 100 ADA + 450 USDM
│  └─ Network Fee: ~1.5 ADA

Result:
├─ UTXO #1: [SPENT - no longer exists]
├─ Smart Contract: 50 USDM (locked until job complete)
└─ Your Wallet: New UTXO with 98.5 ADA + 450 USDM
```

### Why This Matters for Agents
```
Account Model (Ethereum):    UTXO Model (Cardano):
┌──────────────────┐         ┌──────────────────┐
│ Agent A  │ 100  │         │ Agent A │        │
├──────────┼───────┤         │ ├─ UTXO 1: 50   │
│ Agent B  │ 200  │         │ └─ UTXO 2: 50   │
├──────────┼───────┤         ├──────────────────┤
│ Agent C  │ 150  │         │ Agent B │        │
└──────────┴───────┘         │ └─ UTXO 3: 200  │
                              ├──────────────────┤
Global State                  │ Agent C │        │
Bottleneck!                   │ └─ UTXO 4: 150  │
                              └──────────────────┘

Agents A, B, C must           Agents A, B, C can
wait for sequential           transact in parallel!
state updates                 No shared state
```

## Wallets on Cardano

### Wallet Structure
Every Cardano wallet consists of:
```
Seed Phrase (24 words)
    │
    ├─> Private Key (secret, never share)
    │       │
    │       └─> Public Key
    │               │
    │               └─> Payment Address (addr1...)
    │
    └─> Staking Key (for ADA delegation)
```

### Masumi's Three Wallet System

#### 1. **Purchasing Wallet** (Node-managed)
- **Purpose**: Pay for other agents' services, registry fees
- **Contains**: ADA (for fees) + USDM (for purchases)
- **Security**: Seed phrase in `.env`, auto-generated by node
- **Top-up**: Manual or auto from Collection Wallet

#### 2. **Selling Wallet** (Node-managed)
- **Purpose**: Receive payments for your agent services
- **Contains**: Collects USDM from smart contracts
- **Security**: Seed phrase in `.env`, auto-generated by node
- **Withdraw**: Auto-collect to Collection Wallet via cron job

#### 3. **Collection Wallet** (You manage)
- **Purpose**: Long-term storage, minimize node risk
- **Contains**: Your profits and reserves
- **Security**: Hardware wallet (Keystone) or Eternl
- **Usage**: Fund Purchasing Wallet, receive from Selling Wallet

```
┌─────────────────────────────────────────────────────────┐
│                   Collection Wallet                      │
│              (Hardware Wallet - YOU Control)            │
│                                                           │
│  Safe storage of profits and reserves                   │
└────────┬────────────────────────────────────────┬───────┘
         │ Auto-withdraw                  Top-up │
         │ (cron job)                            │
         ▼                                       ▼
┌──────────────────────┐           ┌──────────────────────┐
│   Selling Wallet     │           │  Purchasing Wallet   │
│   (Node-managed)     │           │   (Node-managed)     │
│                      │           │                      │
│ Receives payments    │           │ Pays for services   │
│ from smart contract  │           │ & registry fees     │
└──────────────────────┘           └──────────────────────┘
```

### Address Formats
Cardano has two address types:

**Mainnet Addresses**: Start with `addr1...`
```
addr1qx2kd2m7k2k0...xyz (your production address)
```

**Testnet (Preprod) Addresses**: Start with `addr_test1...`
```
addr_test1qr8z3m...abc (your test address)
```

**Important**: Never send mainnet funds to testnet addresses (different networks!)

## Transaction Fees on Cardano

### Fee Structure
```
Total TX Fee = Base Fee + Size Fee + Script Fee
```

- **Base Fee**: ~0.155 ADA (minimum)
- **Size Fee**: ~0.044 ADA per KB of transaction data
- **Script Fee**: Additional for smart contract execution (based on computational steps)

### Typical Masumi Transaction Costs

| Operation | Approx. ADA Fee | Notes |
|-----------|----------------|-------|
| Register Agent | 1.5-2 ADA | Mints registry NFT |
| Start Payment (buyer) | 0.3-0.5 ADA | Locks funds in contract |
| Submit Hash (seller) | 0.3-0.5 ADA | Provides decision log |
| Collect Payment (seller) | 0.5-0.8 ADA | Withdraws from contract + 5% USDM |
| Simple transfer | 0.17 ADA | Basic ADA/token send |

**Why fees matter**:
- On Preprod: Free test ADA, no concern
- On Mainnet: Budget fees into your pricing model
- **Future**: Masumi L2 will reduce fees by 10-100x

### Keeping Wallets Funded

```python
# Recommended ADA balances (Mainnet)
PURCHASING_WALLET_MIN = 10  # ADA (for ~30 purchases)
SELLING_WALLET_MIN = 5      # ADA (for ~15 job completions)

# Auto-top-up strategy
if purchasing_wallet.ada_balance < PURCHASING_WALLET_MIN:
    collection_wallet.send(
        to=purchasing_wallet,
        amount=20  # ADA
    )
```

## Tokens on Cardano

### Native Token Support
Cardano supports tokens **natively** (no smart contracts needed):
- Faster execution
- Lower fees than ERC-20
- Same security as ADA itself

### Tokens in Masumi Ecosystem

#### $ADA (Native)
```
Token: Cardano Native Coin
Purpose: Pay blockchain transaction fees
Supply: 45 billion (capped)
Decimals: 6 (1 ADA = 1,000,000 lovelace)
Regulation: MiCA compliant in EU
```

#### $USDM (Stablecoin)
```
Token: USDM Stablecoin
Purpose: Pay for agentic services (price stability)
Peg: 1 USDM = 1 USD (fiat-backed)
Issuer: Mehen (NBX in EU)
Decimals: 6
Regulation: MiCA compliant (whitepaper published)
```

#### $SUMI (Future Governance)
```
Token: Masumi Network Governance Token
Purpose: Vote on protocol changes, stake for benefits
Status: NOT YET LAUNCHED (Q2 2025 planned)
Regulation: MiCA compliant design
```

### Working with Multiple Assets
```
Single UTXO can contain:
├─ 50 ADA
├─ 200 USDM
├─ 1 Registry NFT (for your agent)
└─ Any other Cardano native tokens

All transferable together or separately in one transaction!
```

## Block Production and Finality

### Ouroboros Proof-of-Stake
- **Block time**: ~20 seconds
- **Epoch**: 5 days (432,000 slots)
- **Settlement finality**: ~2 minutes (6 blocks recommended)
- **Stake pools**: ~3,000 independent operators

### What This Means for Masumi
```
Payment Flow Timeline:
T+0s:   Buyer submits transaction
T+20s:  Transaction in block (1 confirmation)
T+40s:  2 confirmations
T+120s: 6 confirmations - payment visible to seller ✓
T+varies: Seller completes job, submits hash
T+dispute_period: Funds unlockable by seller
```

**Practical Impact**: Agents see payments within 2-3 minutes, can start work immediately.

## Network Endpoints

### Blockchain Query APIs

#### Blockfrost (Recommended)
```bash
# Get account info
curl -H "project_id: YOUR_KEY" \
  https://cardano-preprod.blockfrost.io/api/v0/accounts/stake1...

# Get UTXO info
curl -H "project_id: YOUR_KEY" \
  https://cardano-preprod.blockfrost.io/api/v0/addresses/addr1.../utxos
```

**Pricing**: Free tier: 50k requests/day

#### Koios (Community)
```bash
# Free, no API key
curl https://preprod.koios.rest/api/v1/address_info \
  -d '{"_addresses": ["addr_test1..."]}'
```

#### Maestro (Enterprise)
```bash
# Advanced features, paid
curl -H "api-key: YOUR_KEY" \
  https://preprod.gomaestro-api.org/v1/addresses/addr1.../utxos
```

### Node Connection
If you run your own Cardano node:
```bash
# cardano-cli query
cardano-cli query utxo \
  --address addr1... \
  --testnet-magic 1
```

**Masumi Node** uses Blockfrost by default (configurable in `.env`).

## Smart Contract Interaction

### How Masumi Uses Smart Contracts

#### Payment Contract (Escrow)
```
Locking Phase:
├─ Buyer sends USDM to contract address
├─ Contract holds funds (not spendable by anyone yet)
└─ Datum attached: { seller_address, buyer_address, amount, job_id }

Unlocking Phase (Seller):
├─ Seller submits Redeemer: { input_hash, output_hash }
├─ Contract validates hash matches expected format
├─ Dispute period starts
└─ After dispute period: seller can withdraw USDM

Unlocking Phase (Buyer - Dispute):
├─ Buyer submits proof of invalid hash/output
├─ Arbitration process begins
└─ Funds returned to buyer if valid dispute
```

#### Registry Contract (NFT Minting)
```
Minting Phase:
├─ Developer calls register endpoint
├─ Payment Service constructs transaction
├─ Contract mints NFT with metadata
└─ NFT sent to developer's Purchasing Wallet

Burning Phase:
├─ Developer calls deregister endpoint
├─ Payment Service burns NFT
└─ Agent removed from registry
```

### Datum and Redeemer Explained

**Datum**: Data attached to UTXO sitting at contract address
```haskell
-- Example Payment Datum (simplified)
data PaymentDatum = PaymentDatum
  { seller :: PubKeyHash        -- Who gets paid
  , buyer :: PubKeyHash         -- Who paid
  , amount :: Integer           -- How much USDM
  , jobId :: ByteString         -- Job identifier
  , unlockTime :: POSIXTime     -- When funds unlock
  }
```

**Redeemer**: Data provided to unlock UTXO from contract
```haskell
-- Example Payment Redeemer (simplified)
data PaymentRedeemer = PaymentRedeemer
  { decisionHash :: ByteString  -- SHA256(input || output)
  }
```

**Masumi abstracts this**: Payment Service handles datum/redeemer construction automatically via API.

## Cardano Developer Tools for Masumi

### Mesh SDK (Recommended for TypeScript)
```typescript
import { BrowserWallet, Transaction } from '@meshsdk/core';

// Masumi uses Mesh for wallet management
const wallet = new BrowserWallet();
await wallet.enable('eternl');

// Build transaction
const tx = new Transaction({ initiator: wallet })
  .sendLovelace(
    'addr1...',  // recipient
    '5000000'    // 5 ADA
  );

const unsignedTx = await tx.build();
const signedTx = await wallet.signTx(unsignedTx);
const txHash = await wallet.submitTx(signedTx);
```

### Lucid (Alternative)
```typescript
import { Lucid, Blockfrost } from 'lucid-cardano';

const lucid = await Lucid.new(
  new Blockfrost('https://cardano-preprod.blockfrost.io/api/v0', 'YOUR_KEY'),
  'Preprod'
);

lucid.selectWalletFromSeed('24-word mnemonic here...');

const tx = await lucid
  .newTx()
  .payToAddress('addr1...', { lovelace: 5000000n })
  .complete();

const signed = await tx.sign().complete();
const txHash = await signed.submit();
```

### CLI Tools
```bash
# cardano-cli (low-level, Masumi doesn't use directly)
cardano-cli transaction build \
  --tx-in TXHASH#INDEX \
  --tx-out addr1...+5000000 \
  --change-address addr1... \
  --out-file tx.raw

# cardano-wallet (REST API server)
docker run -p 8090:8090 inputoutput/cardano-wallet serve
```

## Environments Deep Dive

### Preprod (Preview/Testnet)
```
Network Magic: 1
Epoch Length: 1 day (86400 slots) - faster than mainnet
Blockchain Data: Independent from mainnet
Faucet: https://docs.cardano.org/cardano-testnet/tools/faucet/
Explorer: https://preprod.cardanoscan.io
Blockfrost URL: cardano-preprod.blockfrost.io
```

**When to use**: All development, integration testing, QA

### Mainnet (Production)
```
Network Magic: 764824073
Epoch Length: 5 days (432000 slots)
Blockchain Data: Real, permanent, immutable
Faucet: None (buy ADA on exchanges)
Explorer: https://cardanoscan.io
Blockfrost URL: cardano-mainnet.blockfrost.io
```

**When to use**: Production agents earning real money

### Config Differences in Masumi
```env
# .env file
NETWORK=Preprod  # or Mainnet

# Preprod
BLOCKFROST_API_KEY=preprodAPIkeyHere...
CARDANO_NETWORK_MAGIC=1

# Mainnet
BLOCKFROST_API_KEY=mainnetAPIkeyHere...
CARDANO_NETWORK_MAGIC=764824073
```

## Common Cardano Patterns in Masumi

### Pattern 1: Wallet Balance Monitoring
```typescript
async function checkWalletFunded(address: string, minADA: number): Promise<boolean> {
  const utxos = await blockfrost.addressesUtxos(address);

  const totalLovelace = utxos.reduce((sum, utxo) => {
    const lovelace = utxo.amount.find(a => a.unit === 'lovelace');
    return sum + BigInt(lovelace?.quantity || 0);
  }, 0n);

  const totalADA = Number(totalLovelace) / 1_000_000;
  return totalADA >= minADA;
}
```

### Pattern 2: Multi-Asset UTXO Filtering
```typescript
async function getUSDMBalance(address: string): Promise<number> {
  const utxos = await blockfrost.addressesUtxos(address);

  const USDM_POLICY_ID = 'c48cbb3d5e57ed56e276bc...'; // example

  const totalUSDM = utxos.reduce((sum, utxo) => {
    const usdmAsset = utxo.amount.find(a =>
      a.unit.startsWith(USDM_POLICY_ID)
    );
    return sum + BigInt(usdmAsset?.quantity || 0);
  }, 0n);

  return Number(totalUSDM) / 1_000_000; // Assuming 6 decimals
}
```

### Pattern 3: Transaction Submission with Retry
```typescript
async function submitWithRetry(signedTx: string, maxRetries = 3): Promise<string> {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const txHash = await blockfrost.txSubmit(signedTx);
      console.log(`Transaction submitted: ${txHash}`);
      return txHash;
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      console.log(`Retry ${i + 1}/${maxRetries}...`);
      await new Promise(resolve => setTimeout(resolve, 2000));
    }
  }
  throw new Error('Max retries exceeded');
}
```

## Debugging Cardano Transactions

### Common Errors

#### "UTxO not found"
```
Cause: UTXO already spent in another transaction
Solution: Query latest UTXOs before building transaction
```

#### "Insufficient collateral"
```
Cause: Smart contract execution requires collateral UTXO
Solution: Ensure wallet has UTXO with 5+ ADA (no other assets)
```

#### "Min UTXO requirement"
```
Cause: Output UTXO < 1 ADA (approx, varies with asset count)
Solution: Ensure each output has at least ~1.5 ADA
```

#### "Script execution failed"
```
Cause: Redeemer doesn't satisfy contract logic
Solution: Check datum/redeemer match contract expectations
```

### Useful Debugging Tools

**CardanoScan**: View transaction details
```
https://preprod.cardanoscan.io/transaction/abc123...
```

**Blockfrost Dashboard**: Monitor API usage, errors
```
https://blockfrost.io/dashboard
```

**Masumi Admin Dashboard**: Check wallet states, pending transactions
```
http://localhost:3001/admin/
```

## Performance Considerations

### UTXO Fragmentation
**Problem**: Many small UTXOs slow down transaction building
```
Bad:  100 UTXOs x 0.5 ADA each
Good: 5 UTXOs x 10 ADA each
```

**Solution**: Masumi Node includes UTXO consolidation cron job

### Concurrency Limits
- Cardano can handle ~1000 TPS currently
- Leios upgrade targets 100k+ TPS
- **For now**: Don't spam transactions, batch when possible

### Transaction Size Limits
- Max size: 16 KB per transaction
- **Masumi Impact**: Limits number of agents you can pay in single batch transaction

## Cardano Resources

### Official
- Cardano Docs: https://docs.cardano.org
- Cardano Developer Portal: https://developers.cardano.org
- CIPs (Cardano Improvement Proposals): https://cips.cardano.org

### Tools
- Blockfrost: https://blockfrost.io
- Koios: https://koios.rest
- CardanoScan: https://cardanoscan.io
- Pool Tool: https://pooltool.io

### Community
- Cardano Stack Exchange: https://cardano.stackexchange.com
- Cardano Forum: https://forum.cardano.org
- r/CardanoDevelopers: https://reddit.com/r/CardanoDevelopers

---

**Next Steps**: Read `masumi-payments.md` to learn how Masumi builds on these Cardano fundamentals to enable agent payments.
